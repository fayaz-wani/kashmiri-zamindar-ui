<!-- features/products/product-detail/product-detail.html -->

<!-- Breadcrumb Navigation -->
<section class="breadcrumb-section">
  <div class="container">
    <nav class="breadcrumb">
      <a routerLink="/products" class="breadcrumb-link">Products</a>
      <span class="breadcrumb-separator">‚Ä∫</span>
      <span *ngIf="product" class="breadcrumb-current">{{ product.category }}</span>
      <span class="breadcrumb-separator">‚Ä∫</span>
      <span *ngIf="product" class="breadcrumb-current">{{ product.name }}</span>
    </nav>
  </div>
</section>

<!-- Loading State -->
<div *ngIf="loading" class="loading-container">
  <div class="spinner"></div>
  <p>Loading product details...</p>
</div>

<!-- Error State -->
<div *ngIf="error" class="error-container">
  <div class="error-message">
    <i class="error-icon">‚ö†Ô∏è</i>
    <h3>{{ error }}</h3>
    <button (click)="goBack()" class="back-btn">Back to Products</button>
  </div>
</div>

<!-- Product Detail -->
<section *ngIf="product && !loading && !error" class="product-detail-section">
  <div class="container">
    <div class="product-detail-grid">
      
      <!-- Left Column - Images -->
      <div class="product-images-column">
        
        <!-- Main Image with Zoom -->
        <div class="main-image-container">
          <div 
            class="main-image-wrapper"
            [class.zoomed]="isZoomed()"
            (mouseenter)="enableZoom()"
            (mouseleave)="disableZoom()"
            (mousemove)="handleImageZoom($event)">
            
            <img 
              [src]="getImageUrl(selectedImage())" 
              [alt]="product.name"
              class="main-image"
              [style.transform-origin]="zoomPosition().x + '% ' + zoomPosition().y + '%'">
            
            <!-- Navigation Arrows -->
            <button 
              *ngIf="product.images && product.images.length > 1"
              class="nav-arrow prev-arrow" 
              (click)="previousImage()"
              aria-label="Previous Image">
              ‚Äπ
            </button>
            <button 
              *ngIf="product.images && product.images.length > 1"
              class="nav-arrow next-arrow" 
              (click)="nextImage()"
              aria-label="Next Image">
              ‚Ä∫
            </button>

            <!-- Zoom Hint (Desktop only) -->
            <div class="zoom-hint">üîç Hover to zoom</div>
          </div>

          <!-- Image Counter -->
          <div *ngIf="product.images && product.images.length > 1" class="image-counter">
            {{ selectedImageIndex() + 1 }} / {{ product.images.length }}
          </div>
        </div>

        <!-- Thumbnail Gallery -->
        <div *ngIf="product.images && product.images.length > 1" class="thumbnail-gallery">
          <div 
            *ngFor="let image of product.images; let i = index"
            class="thumbnail-wrapper"
            [class.active]="selectedImageIndex() === i"
            (click)="selectImage(image, i)">
            <img 
              [src]="getImageUrl(image.imageUrl)" 
              [alt]="product.name + ' - Image ' + (i + 1)"
              class="thumbnail-image">
          </div>
        </div>

      </div>

      <!-- Right Column - Product Info -->
      <div class="product-info-column">
        
        <!-- Category Badge -->
        <div class="category-badge">{{ product.category }}</div>

        <!-- Product Name -->
        <h1 class="product-title">{{ product.name }}</h1>

        <!-- Rating & Reviews -->
        <div class="rating-section">
          <div class="stars">
            <span 
              *ngFor="let star of getRatingStars(); let i = index"
              class="star"
              [class.filled]="i < averageRating">
              {{ i < averageRating ? '‚òÖ' : '‚òÜ' }}
            </span>
          </div>
          <span class="rating-text">{{ averageRating.toFixed(1) }}</span>
          <span class="review-count">({{ totalReviews }} reviews)</span>
        </div>

        <!-- Price Section -->
        <div class="price-section">
          <div class="price-main">
            <span class="current-price">{{ formatPrice(product.price) }}</span>
            <span class="price-unit">per {{ product.unit }}</span>
          </div>
        </div>

        <!-- Stock Status (Dynamic) -->
        <div class="stock-status" [ngClass]="stockStatus()">
          <span class="status-icon">
            {{ stockStatus() === 'in-stock' ? '‚úì' : stockStatus() === 'low-stock' ? '‚ö†Ô∏è' : '‚úó' }}
          </span>
          <span>
            {{ stockStatus() === 'in-stock' ? 'In Stock' : 
               stockStatus() === 'low-stock' ? 'Low Stock - Only ' + product.stockQuantity + ' left!' : 
               'Out of Stock' }}
          </span>
        </div>

        <!-- Share & Wishlist -->
        <div class="share-wishlist-section">
          <button class="btn-icon-text" (click)="shareProduct('copy')">
            <span class="icon">üîó</span>
            <span>Share</span>
          </button>
          <button class="btn-icon-text" (click)="addToWishlist()">
            <span class="icon">‚ù§Ô∏è</span>
            <span>Wishlist</span>
          </button>
        </div>

        <!-- Quick Description (Mobile) -->
        <div class="product-description mobile-only">
          <p>{{ product.description }}</p>
        </div>

        <!-- Product Details -->
        <div class="product-details">
          <h3>Product Details</h3>
          <ul class="details-list">
            <li>
              <span class="detail-label">Category:</span>
              <span class="detail-value">{{ product.category }}</span>
            </li>
            <li>
              <span class="detail-label">Unit:</span>
              <span class="detail-value">{{ product.unit }}</span>
            </li>
            <li *ngIf="product.stockQuantity">
              <span class="detail-label">Available:</span>
              <span class="detail-value">{{ product.stockQuantity }} {{ product.unit }}s</span>
            </li>
          </ul>
        </div>

        <!-- Quantity Selector -->
        <div class="quantity-section">
          <label class="quantity-label">Quantity:</label>
          <div class="quantity-controls">
            <button 
              class="quantity-btn"
              (click)="decreaseQuantity()"
              [disabled]="quantity() <= 1">
              ‚àí
            </button>
            <input 
              type="number" 
              class="quantity-input"
              [value]="quantity()"
              readonly>
            <button 
              class="quantity-btn"
              (click)="increaseQuantity()"
              [disabled]="stockStatus() === 'out-of-stock'">
              +
            </button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button 
            class="btn btn-primary btn-large" 
            (click)="addToCart()"
            [disabled]="stockStatus() === 'out-of-stock'">
            <span class="btn-icon">üõí</span>
            <span>Add to Cart</span>
          </button>
          <button 
            class="btn btn-secondary btn-large" 
            (click)="buyNow()"
            [disabled]="stockStatus() === 'out-of-stock'">
            <span class="btn-icon">‚ö°</span>
            <span>Buy Now</span>
          </button>
        </div>

        <!-- Trust Badges -->
        <div class="trust-badges-compact">
          <div class="trust-item">
            <span class="trust-icon">üöö</span>
            <span>Free Delivery</span>
          </div>
          <div class="trust-item">
            <span class="trust-icon">‚Ü©Ô∏è</span>
            <span>Easy Returns</span>
          </div>
          <div class="trust-item">
            <span class="trust-icon">‚úì</span>
            <span>100% Authentic</span>
          </div>
        </div>

      </div>
    </div>

    <!-- ‚úÖ TABS SECTION (ONLY ONE - BELOW MAIN GRID) -->
    <div class="additional-info-section">
      <div class="info-tabs">
        <button 
          class="tab-btn" 
          [class.active]="activeTab() === 'description'"
          (click)="switchTab('description')">
          Description
        </button>
        <button 
          class="tab-btn" 
          [class.active]="activeTab() === 'reviews'"
          (click)="switchTab('reviews')">
          Reviews ({{ totalReviews }})
        </button>
        <button 
          class="tab-btn" 
          [class.active]="activeTab() === 'shipping'"
          (click)="switchTab('shipping')">
          Shipping
        </button>
      </div>

      <div class="tab-content">
        <!-- Description Tab -->
        <div *ngIf="activeTab() === 'description'" class="extended-description">
          <h3>About This Product</h3>
          <p>{{ product.description }}</p>
          <p>
            Our {{ product.name }} is sourced directly from local artisans and farmers in Kashmir, 
            ensuring the highest quality and authenticity.
          </p>
          <h4>Key Features:</h4>
          <ul>
            <li>100% Pure and Natural</li>
            <li>Directly sourced from Kashmir</li>
            <li>Premium quality guaranteed</li>
            <li>Carefully packaged for freshness</li>
            <li>Supports local communities</li>
          </ul>
        </div>

        <!-- Reviews Tab -->
        <div *ngIf="activeTab() === 'reviews'" class="reviews-section">
          <!-- Reviews Summary -->
          <div class="reviews-summary">
            <div class="rating-overview">
              <div class="rating-score">
                <span class="score-number">{{ product.averageRating?.toFixed(1) || '0.0' }}</span>
                <div class="score-stars">
                  <span 
                    *ngFor="let star of getRatingStars()"
                    class="star"
                    [class.filled]="star < (product.averageRating || 0)">
                    {{ star < (product.averageRating || 0) ? '‚òÖ' : '‚òÜ' }}
                  </span>
                </div>
                <span class="score-text">Based on {{ totalReviews }} reviews</span>
              </div>

              <!-- Rating Distribution -->
              <div class="rating-distribution" *ngIf="product.ratingDistribution">
                <div class="rating-bar" *ngFor="let level of [5, 4, 3, 2, 1]">
                  <span class="bar-label">{{ level }} ‚òÖ</span>
                  <div class="bar-container">
                    <div class="bar-fill" [style.width.%]="getRatingPercentage(level)"></div>
                  </div>
                  <span class="bar-count">
                    {{ level === 5 ? product.ratingDistribution.rating5Count :
                       level === 4 ? product.ratingDistribution.rating4Count :
                       level === 3 ? product.ratingDistribution.rating3Count :
                       level === 2 ? product.ratingDistribution.rating2Count :
                       product.ratingDistribution.rating1Count }}
                  </span>
                </div>
              </div>
            </div>

            <button class="btn btn-primary" (click)="toggleReviewForm()">
              {{ showReviewForm() ? 'Cancel' : 'Write a Review' }}
            </button>
          </div>

          <!-- Add Review Form -->
          <div *ngIf="showReviewForm()" class="review-form">
            <h3>Write Your Review</h3>
            <div class="form-group">
              <label>Your Rating *</label>
              <div class="rating-selector">
                <span 
                  *ngFor="let star of getRatingStars()"
                  class="star-select"
                  [class.selected]="star < reviewForm().rating"
                  (click)="setRating(star + 1)">
                  {{ star < reviewForm().rating ? '‚òÖ' : '‚òÜ' }}
                </span>
              </div>
            </div>

            <div class="form-group">
              <label for="reviewerName">Your Name *</label>
              <input 
                type="text" 
                id="reviewerName"
                [(ngModel)]="reviewForm().customerName"
                class="form-input"
                required>
            </div>

            <div class="form-group">
              <label for="reviewerEmail">Your Email</label>
              <input 
                type="email" 
                id="reviewerEmail"
                [(ngModel)]="reviewForm().customerEmail"
                class="form-input">
            </div>

            <div class="form-group">
              <label for="reviewTitle">Review Title</label>
              <input 
                type="text" 
                id="reviewTitle"
                [(ngModel)]="reviewForm().reviewTitle"
                class="form-input"
                placeholder="Sum up your experience">
            </div>

            <div class="form-group">
              <label for="reviewText">Your Review *</label>
              <textarea 
                id="reviewText"
                [(ngModel)]="reviewForm().reviewText"
                class="form-textarea"
                rows="5"
                placeholder="Tell us about your experience"
                required></textarea>
            </div>

            <button class="btn btn-primary" (click)="submitReview()">
              Submit Review
            </button>
          </div>

          <!-- Reviews List -->
          <div class="reviews-list">
            <div *ngIf="loadingReviews()" class="loading-reviews">
              <div class="spinner"></div>
              <p>Loading reviews...</p>
            </div>

            <div *ngIf="!loadingReviews() && reviews().length === 0" class="no-reviews">
              <p>No reviews yet. Be the first to review this product!</p>
            </div>

            <div *ngFor="let review of reviews()" class="review-card">
              <div class="review-header">
                <div class="reviewer-info">
                  <span class="reviewer-name">{{ review.customerName }}</span>
                  <span class="verified-badge" *ngIf="review.isVerifiedPurchase">
                    ‚úì Verified Purchase
                  </span>
                </div>
                <div class="review-rating">
                  <span 
                    *ngFor="let star of getRatingStars()"
                    class="star"
                    [class.filled]="star < review.rating">
                    {{ star < review.rating ? '‚òÖ' : '‚òÜ' }}
                  </span>
                </div>
              </div>

              <h4 *ngIf="review.reviewTitle" class="review-title">{{ review.reviewTitle }}</h4>
              <p class="review-text">{{ review.reviewText }}</p>
              
              <div class="review-footer">
                <span class="review-date">{{ formatDate(review.createdAt) }}</span>
                <button class="helpful-btn" (click)="markHelpful(review.reviewId)">
                  üëç Helpful ({{ review.helpfulCount }})
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Shipping Tab -->
        <div *ngIf="activeTab() === 'shipping'" class="shipping-info">
          <h3>Shipping Information</h3>
          <div class="shipping-details">
            <div class="shipping-option">
              <div class="option-icon">üöö</div>
              <div class="option-details">
                <h4>Standard Delivery</h4>
                <p>Free shipping on orders above ‚Çπ999</p>
                <p class="delivery-time">Delivered in 5-7 business days</p>
              </div>
            </div>

            <div class="shipping-option">
              <div class="option-icon">‚ö°</div>
              <div class="option-details">
                <h4>Express Delivery</h4>
                <p>‚Çπ150 additional charge</p>
                <p class="delivery-time">Delivered in 2-3 business days</p>
              </div>
            </div>

            <div class="shipping-option">
              <div class="option-icon">‚Ü©Ô∏è</div>
              <div class="option-details">
                <h4>Easy Returns</h4>
                <p>30-day return policy</p>
                <p class="delivery-time">Free return pickup available</p>
              </div>
            </div>
          </div>

          <div class="shipping-note">
            <h4>Important Notes:</h4>
            <ul>
              <li>Orders placed before 2 PM are shipped the same day</li>
              <li>Delivery times may vary for remote locations</li>
              <li>Track your order in real-time after shipment</li>
              <li>Contact support for any delivery issues</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Related Products -->
    <div class="related-products-section" *ngIf="relatedProducts().length > 0">
      <h2 class="section-title">You May Also Like</h2>
      <div class="related-products-grid">
        <div 
          *ngFor="let relatedProduct of relatedProducts()"
          class="related-product-card"
          (click)="navigateToProduct(relatedProduct.productGuid)">
          <div class="related-product-image">
            <img [src]="getImageUrl(relatedProduct.imageUrl)" [alt]="relatedProduct.name">
          </div>
          <h4>{{ relatedProduct.name }}</h4>
          <p class="related-price">{{ formatPrice(relatedProduct.price) }}</p>
          <p class="related-unit">per {{ relatedProduct.unit }}</p>
        </div>
      </div>
    </div>

  </div>
</section>